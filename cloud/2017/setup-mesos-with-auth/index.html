<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>CentOS 7 安装支持认证的Mesos集群 | Ying的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在CentOS 7上安装Mesos集群，设置对Slave和框架的认证，改为普通用户执行任务。Chronos在容器中执行GPU作业。">
<meta property="og:type" content="article">
<meta property="og:title" content="CentOS 7 安装支持认证的Mesos集群">
<meta property="og:url" content="https://ying-zhang.github.io/cloud/2017/setup-mesos-with-auth/index.html">
<meta property="og:site_name" content="Ying的博客">
<meta property="og:description" content="在CentOS 7上安装Mesos集群，设置对Slave和框架的认证，改为普通用户执行任务。Chronos在容器中执行GPU作业。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-01-14T02:16:13.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CentOS 7 安装支持认证的Mesos集群">
<meta name="twitter:description" content="在CentOS 7上安装Mesos集群，设置对Slave和框架的认证，改为普通用户执行任务。Chronos在容器中执行GPU作业。">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-setup-mesos-with-auth" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CentOS 7 安装支持认证的Mesos集群
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/cloud/2017/setup-mesos-with-auth/" class="article-date">
  <time datetime="2017-12-19T16:00:00.000Z" itemprop="datePublished">2017-12-20</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/cloud/">cloud</a>
  </div>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在CentOS 7上安装Mesos集群，设置对Slave和框架的认证，改为普通用户执行任务。Chronos在容器中执行GPU作业。</p>
<hr>
<a id="more"></a>
<blockquote>
<p>注意：<br>以下的设置都是以root用户权限执行的。<br>机器的操作系统是CentOS 7，机器名n5（<code>/etc/hostname</code>和<code>/etc/hosts</code>都设置了机器名），IP地址10.1.1.5 。<br>为了简便，Mesos Master和Slave在同一台机器上，Zookeeper也是单机运行模式。</p>
</blockquote>
<h1 id="Mesos集群基本设置"><a href="#Mesos集群基本设置" class="headerlink" title="Mesos集群基本设置"></a>Mesos集群基本设置</h1><h2 id="安装JDK"><a href="#安装JDK" class="headerlink" title="安装JDK"></a>安装JDK</h2><p>先安装Open JDK 8<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">yum install -y java-1.8.0-openjdk java-1.8.0-openjdk-devel</div><div class="line"></div><div class="line"># 在/etc/profile末尾增加环境变量，下文会把Zookeeper安装到/opt/zookeeper</div><div class="line">export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk</div><div class="line">export PATH=$PATH:$JAVA_HOME/bin:/opt/zookeeper/bin</div></pre></td></tr></table></figure></p>
<h2 id="安装Zookeeper"><a href="#安装Zookeeper" class="headerlink" title="安装Zookeeper"></a>安装Zookeeper</h2><p>下载并设置Zookeeper，参考[<a href="https://zookeeper.apache.org/doc/r3.4.11/zookeeperStarted.html" target="_blank" rel="external">https://zookeeper.apache.org/doc/r3.4.11/zookeeperStarted.html</a>] 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">cd ~</div><div class="line">curl -O http://mirrors.nju.edu.cn/apache/zookeeper/zookeeper-3.4.11/zookeeper-3.4.11.tar.gz</div><div class="line">tar axf zookeeper-3.4.11.tar.gz -C /opt/</div><div class="line">rm  zookeeper-3.4.11.tar.gz</div><div class="line">mv  /opt/zookeeper-3.4.11/ /opt/zookeeper</div><div class="line"></div><div class="line"># 因为只使用一台机器，zk设置了server.1=n5:2881:3881，myid为1</div><div class="line"># 更多的机器需要分别修改 myid 和 server.&lt;id&gt;</div><div class="line">cat &gt; /opt/zookeeper/conf/zoo.cfg &lt;&lt;EOF</div><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/var/lib/zookeeper</div><div class="line">dataLogDir=/var/log/zookeeper</div><div class="line">clientPort=2181</div><div class="line">server.1=n5:2881:3881</div><div class="line">EOF</div><div class="line"></div><div class="line">mkdir /var/lib/zookeeper /var/log/zookeeper</div><div class="line">echo  1 &gt;/var/lib/zookeeper/myid</div></pre></td></tr></table></figure></p>
<p>因为前面将<code>/opt/zookeeper/bin</code>加入了<code>$PATH</code>环境变量，所以可以直接输入下面的命令，</p>
<ul>
<li><code>zkServer.sh start</code>，启动Zookeeper。</li>
<li><code>zkServer.sh status</code>，正常的话会输出包含<code>Mode: standalone</code>的信息，即处于单独运行模式。</li>
<li><code>zkCli.sh -server n5:2181</code> 或 <code>zkCli.sh</code>，以进入Zookeeper的Shell，在其中查看和修改Zookeeper的值。</li>
</ul>
<p>设置Zookeeper的Systemd服务配置文件，编辑文件 <code>/lib/systemd/system/zookeeper.service</code> ，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Apache Zookeeper</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=forking</div><div class="line">User=root</div><div class="line">Group=root</div><div class="line">Environment=JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk</div><div class="line">ExecStart=/opt/zookeeper/bin/zkServer.sh start</div><div class="line">ExecStop=/opt/zookeeper/bin/zkServer.sh stop</div><div class="line">ExecReload=/opt/zookeeper/bin/zkServer.sh restart</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>启动Zookeeper服务：<code>systemctl enable zookeeper.service; systemctl start zookeeper.service</code><br>确认服务正常启动了：<code>zkServer.sh status</code></p>
<h2 id="安装Mesos，Marathon和Chronos"><a href="#安装Mesos，Marathon和Chronos" class="headerlink" title="安装Mesos，Marathon和Chronos"></a>安装Mesos，Marathon和Chronos</h2><p>参考《Mesos实战》，通过Mesosphere的源安装Mesos，Marathon和Chronos。<br>由于Mesosphere（dc/os）修改了文档（可能是为了推广dc/os吧），现在的<a href="https://mesos.apache.org" target="_blank" rel="external">Apache Mesos</a>官方文档不太友好，好在安装包源还可以用。</p>
<blockquote>
<p>Ubuntu的源是 [<a href="http://repos.mesosphere.io/ubuntu" target="_blank" rel="external">http://repos.mesosphere.io/ubuntu</a>]</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm</div><div class="line">yum install -y http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm</div><div class="line">yum install -y mesos marathon chronos haproxy</div></pre></td></tr></table></figure>
<p>安装的版本分别是（2017-12-21）：Mesos 1.4.1，Marathon 1.5.4，Chronos 2.5.1</p>
<p>安装后，会创建 Mesos Master 和 Slave 的Systemd服务配置文件，还设置了<code>/etc/mesos/zk</code>文件内容为<code>zk://localhost:2181/mesos</code>，这正是Zookeeper的默认端口，就无需更改了。</p>
<p>对多个网卡的机器，如果要mesos使用某个特定的网卡，就需要在<code>/etc/default/mesos-master</code>中设置该网卡对应的IP地址，这里是<code>IP=10.1.1.5</code>。还可以在这个文件设置<code>HOSTNAME</code>（机器名）和<code>CLUSTER</code>（mesos集群名）。<br>其实也可以在这个文件设置<code>zk</code>，不过这只对Master有效。</p>
<p>在<code>/etc/default/mesos</code>这个文件的设置对master和slave都有效。</p>
<blockquote>
<p>一些参数既可以直接作为启动命令的命令行参数，也可以作为环境变量写到上面提到的配置文件中。<br>这些配置文件的路径是硬编码在<code>/usr/bin/mesos-init-wrapper</code>这个启动脚本中的。</p>
</blockquote>
<p>然后就可以启动服务了，为了简便，这里关闭了系统的防火墙：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl disable firewalld; systemctl stop firewalld </div><div class="line">systemctl restart mesos-master mesos-slave chronos marathon</div><div class="line">systemctl status  mesos-master mesos-slave chronos marathon</div></pre></td></tr></table></figure></p>
<blockquote>
<p>Mesosphere的yum仓库中也有zookeeper，可执行<code>yum install -y mesosphere-zookeeper</code>安装，会安装到<code>/opt/mesosphere/zookeeper/bin/</code>，并生成<code>zookeeper.service</code>的systemd服务（当然需要配置server.id，并手动启用服务）。</p>
</blockquote>
<p>通过（其它机器的）浏览器访问<code>http://10.1.1.5:5050</code>，应该就可以打开Mesos Web UI了，在Framworks中会列出Chronos，访问<code>http://10.1.1.5:4400</code>，可以打开Chronos Web UI。但<strong>Marathon没有启动成功</strong>。</p>
<h2 id="处理Marathon服务启动问题"><a href="#处理Marathon服务启动问题" class="headerlink" title="处理Marathon服务启动问题"></a>处理Marathon服务启动问题</h2><p>参考 [<a href="https://github.com/mesosphere/marathon" target="_blank" rel="external">https://github.com/mesosphere/marathon</a>] 。<br>修改Marathon的Systemd服务配置文件<code>/usr/lib/systemd/system/marathon.service</code>，主要是在启动命令增加了<code>master</code>和<code>zk</code>参数（注意参数与值之间是用空格分隔的，不要写成<strong>等号“=”</strong>；zk的路径是marathon，不是mesos），用户改为<code>root</code>，并改正了<code>mkdir</code>和<code>chmod</code>的完整路径。<br>完整内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Scheduler for Apache Mesos</div><div class="line">Requires=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">WorkingDirectory=/usr/share/marathon</div><div class="line">EnvironmentFile=/etc/default/marathon</div><div class="line">Environment=&quot;JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk&quot; </div><div class="line">ExecStart=/usr/share/marathon/bin/marathon      \</div><div class="line">    --master n5:5050 --zk zk://n5:2181/marathon</div><div class="line"></div><div class="line">ExecReload=/usr/bin/kill -HUP $MAINPID</div><div class="line">Restart=always</div><div class="line">RestartSec=60</div><div class="line">SuccessExitStatus=</div><div class="line">User=root</div><div class="line">ExecStartPre=/usr/bin/mkdir -p /run/marathon</div><div class="line">ExecStartPre=/usr/bin/chmod 755 /run/marathon</div><div class="line">PermissionsStartOnly=true</div><div class="line">LimitNOFILE=1024</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>保存上述设置文件后，执行<code>systemctl daemon-reload; systemctl restart marathon</code>重启服务，稍等一会儿，Mesos Web UI的Framworks列表中就有Marathon了。Marathon Web UI地址是<code>http://10.1.1.5:8080</code>。</p>
<h1 id="清理Mesos集群"><a href="#清理Mesos集群" class="headerlink" title="清理Mesos集群"></a>清理Mesos集群</h1><blockquote>
<p>这节是为强迫症患者准备的。</p>
</blockquote>
<p>清理运行任务记录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">systemctl stop mesos-master mesos-slave</div><div class="line">rm -rf /var/mesos /var/log/mesos</div><div class="line">mkdir  /var/mesos /var/log/mesos</div><div class="line"></div><div class="line">/opt/zookeeper/bin/zkCli.sh #进入zk的shell，执行下面的命令</div><div class="line">rmr /mesos</div><div class="line">rmr /chronos</div><div class="line">rmr /marathon</div><div class="line">quit # 退出zk的shell</div><div class="line"></div><div class="line">systemctl start mesos-master mesos-slave</div></pre></td></tr></table></figure></p>
<p>清理mesos下载的镜像文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">systemctl stop mesos-master mesos-slave</div><div class="line">rm -rf /tmp/mesos</div><div class="line">mkdir  /tmp/mesos</div><div class="line"></div><div class="line">systemctl start mesos-master mesos-slave</div></pre></td></tr></table></figure></p>
<h1 id="支持GPU资源"><a href="#支持GPU资源" class="headerlink" title="支持GPU资源"></a>支持GPU资源</h1><h2 id="Mesos-Slave的设置"><a href="#Mesos-Slave的设置" class="headerlink" title="Mesos Slave的设置"></a>Mesos Slave的设置</h2><blockquote>
<p>当然，首先要有GPU硬件，且安装了硬件驱动。可参考<a href="/cloud/2017/setup-tensorflow-gpu-centos7/">CentOS 7 安装TensorFlow GPU深度学习环境</a>。<br>参考：[<a href="http://mesos.apache.org/documentation/latest/gpu-support/" target="_blank" rel="external">http://mesos.apache.org/documentation/latest/gpu-support/</a>]</p>
</blockquote>
<p>对GPU的支持是Mesos Slave负责的，在<code>/etc/default/mesos-slave</code>中增加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ISOLATION=&quot;gpu/nvidia,filesystem/linux,docker/runtime,cgroups/cpu,cgroups/mem,network/cni,cgroups/perf_event,posix/disk,cgroups/devices&quot;</div></pre></td></tr></table></figure></p>
<p>由于使用GPU的容器需要Nvidia提供的运行时插件，Mesos只支持自己的容器引擎加载GPU：它可以使用Docker的镜像文件，但运行时是Mesos实现的，而不是Docker。<br>由此导致容器中的默认环境变量没有包括Nvidia的可执行文件和动态库的路径，为了方便，在Slave设置一个默认的环境变量，同样是在<code>/etc/default/mesos-slave</code>中，增加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">executor_environment_variables=/etc/mesos/slave-executor-env.json</div></pre></td></tr></table></figure></p>
<p>其中<code>/etc/mesos/slave-executor-env.json</code>是手动创建的文件，内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;PATH&quot;:&quot;/opt/anaconda3/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,</div><div class="line">&quot;LD_LIBRARY_PATH&quot;:&quot;/usr/local/cuda/extras/CUPTI/lib64:/usr/local/nvidia/lib:/usr/local/nvidia/lib64&quot;,</div><div class="line">&quot;http_proxy&quot;: &quot;http://n147:3128&quot;,</div><div class="line">&quot;https_proxy&quot;:&quot;http://n147:3128&quot;,</div><div class="line">&quot;TZ&quot;:&quot;GMT-8&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先停止Slave服务，删除旧的临时文件<code>rm -f /var/mesos/meta/slaves/latest</code>，<br>然后重启服务<code>systemctl restart mesos-slave</code>，刷新Mesos Web UI，应该就可以看到新增的GPU资源了。</p>
<h2 id="Marathon的设置"><a href="#Marathon的设置" class="headerlink" title="Marathon的设置"></a>Marathon的设置</h2><p>在Marathon的Systemd服务配置文件的<code>ExecStart</code>处增加参数，完整的启动命令是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ExecStart=/usr/share/marathon/bin/marathon      \</div><div class="line">    --master n5:5050 --zk zk://n5:2181/marathon \</div><div class="line">    --enable_features gpu_resources</div></pre></td></tr></table></figure></p>
<p>重启服务<code>systemctl daemon-reload; systemctl restart marathon</code>，可以在Marathon Web UI的about页面 [<a href="http://10.1.1.5:8080/ui/#/apps?modal=about" target="_blank" rel="external">http://10.1.1.5:8080/ui/#/apps?modal=about</a>] 确认启用了GPU。</p>
<h2 id="Chronos的设置"><a href="#Chronos的设置" class="headerlink" title="Chronos的设置"></a>Chronos的设置</h2><p><a href="https://github.com/mesos/chronos" target="_blank" rel="external">Mesos官方版的Chronos</a> 还不支持GPU，我们使用一个修改过的Fork [<a href="https://github.com/reneploetz/chronos" target="_blank" rel="external">https://github.com/reneploetz/chronos</a>] ，从源码编译（需预先安装Maven）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cd ~</div><div class="line">git clone https://github.com/reneploetz/chronos.git</div><div class="line"></div><div class="line">cd chronos</div><div class="line"># 自带的 ./build-release.sh 脚本是在Docker容器中构建的，这里直接用Maven编译</div><div class="line"># 需要预先安装Maven。构建的版本号是3.0.3。</div><div class="line"></div><div class="line">curl --silent --location https://rpm.nodesource.com/setup_8.x | sudo bash -</div><div class="line">yum install -y nodejs</div><div class="line">mvn clean package -Dmaven.test.skip=true</div></pre></td></tr></table></figure></p>
<p>下面停用从官方源安装的Chronos服务，从命令行启动支持GPU的Chronos（当然，也可以修改Chronos的Systemd服务配置文件，使用支持GPU的Chronos）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">systemctl disable chronos; systemctl stop chronos</div><div class="line"></div><div class="line">nohup java -jar /root/chronos/target/chronos-3.0.3-SNAPSHOT.jar \</div><div class="line">  --master zk://n5:2181/mesos --http_port=4400                  \</div><div class="line">  --enable_features=gpu_resources &gt;/dev/null                    &amp;</div></pre></td></tr></table></figure></p>
<p>启动后再次打开Chronos Web UI，<a href="http://10.1.1.5:4400" target="_blank" rel="external">http://10.1.1.5:4400</a> ，发现与官方最新版的不一样了。<br>添加一个Scheduled Job，Job Name，Command都可以随便填。Web UI中不能指定GPU资源量，需要在Job的JSON配置文件中设置。创建Job后，修改其JSON配置文件，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;host-gpu-test&quot;,</div><div class="line">  &quot;command&quot;: &quot;nvidia-smi &gt; /root/nvidia-smi-out.txt ; whoami; id; pwd&quot;,</div><div class="line">  &quot;shell&quot;: true,</div><div class="line">  &quot;executor&quot;: &quot;&quot;,</div><div class="line">  &quot;executorFlags&quot;: &quot;&quot;,</div><div class="line">  &quot;taskInfoData&quot;: &quot;&quot;,</div><div class="line">  &quot;retries&quot;: 0,</div><div class="line">  &quot;owner&quot;: &quot;&quot;,</div><div class="line">  &quot;ownerName&quot;: &quot;&quot;,</div><div class="line">  &quot;description&quot;: &quot;&quot;,</div><div class="line">  &quot;cpus&quot;: 0.1,</div><div class="line">  &quot;disk&quot;: 256,</div><div class="line">  &quot;mem&quot;: 128,</div><div class="line">  &quot;gpus&quot;: 1,</div><div class="line">  &quot;disabled&quot;: false,</div><div class="line">  &quot;softError&quot;: false,</div><div class="line">  &quot;dataProcessingJobType&quot;: false,</div><div class="line">  &quot;fetch&quot;: [],</div><div class="line">  &quot;uris&quot;: [],</div><div class="line">  &quot;environmentVariables&quot;: [],</div><div class="line">  &quot;arguments&quot;: [],</div><div class="line">  &quot;highPriority&quot;: false,</div><div class="line">  &quot;runAsUser&quot;: &quot;root&quot;,</div><div class="line">  &quot;concurrent&quot;: false,</div><div class="line">  &quot;constraints&quot;: [],</div><div class="line">  &quot;schedule&quot;: &quot;R1//P1Y&quot;,</div><div class="line">  &quot;scheduleTimeZone&quot;: &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>修改了Job设置后，在Web UI点击绿色的Run按钮执行Job。</p>
<ul>
<li>为使用GPU资源，设置<code>&quot;gpus&quot;: 1</code>，机器上共安装了两个GPU，Mesos可以按整数个的粒度分配GPU。</li>
<li>Chronos针对的是定时周期作业，这里只需要执行一次，所以设置了<code>&quot;retries&quot;: 0, &quot;schedule&quot;: &quot;R1//P1Y&quot;</code>，即只重复1次，间隔1年，失败后重试0次。</li>
<li>执行的命令是<code>&quot;command&quot;: &quot;nvidia-smi &gt; /root/nvidia-smi-out.txt ; whoami; id; pwd&quot;</code>。</li>
<li>注意到<code>&quot;runAsUser&quot;: &quot;root&quot;</code>，即用<strong>主机上的root用户账号来运行这个Job</strong>，将<code>nvidia-smi</code>的输出重定向到<code>/root/nvidia-smi-out.txt</code>，Job执行成功后，可以在Host查看这个文件，确认Chronos对GPU的支持运行正常。</li>
<li>通过执行<code>whoami; id</code>也可以<strong>确认是root账号</strong>。</li>
<li>但<code>pwd</code>输出的则是Mesos Slave创建的沙盒的完整路径，看来是没有<code>chroot</code>。</li>
</ul>
<p>要查看任务输出到终端的内容，</p>
<ul>
<li>需要在Mesos Web UI的Frameworks列表点击Chronos的ID，</li>
<li>然后在Completed Tasks中选择任务ID对应的Sandbox链接，</li>
<li>再打开<code>stdout</code>或<code>stderr</code>的链接。</li>
</ul>
<blockquote>
<p>Windows 上用 Chrome v63 打开 Edit Job 的界面，编辑光标总是错位，但在MacOS的Chrome则正常。。。<br>所以先用 VS Code 编辑好再粘贴过去吧。</p>
</blockquote>
<h1 id="对Slave，Framwork的验证"><a href="#对Slave，Framwork的验证" class="headerlink" title="对Slave，Framwork的验证"></a>对Slave，Framwork的验证</h1><h2 id="Mesos-Master的设置"><a href="#Mesos-Master的设置" class="headerlink" title="Mesos Master的设置"></a>Mesos Master的设置</h2><blockquote>
<p>参考：<br><a href="http://mesos.readthedocs.io/en/latest/authentication/" target="_blank" rel="external">http://mesos.readthedocs.io/en/latest/authentication/</a><br><a href="http://mesos.readthedocs.io/en/latest/authorization/" target="_blank" rel="external">http://mesos.readthedocs.io/en/latest/authorization/</a> </p>
</blockquote>
<p>注意到Chronos的Job是以root账号执行的，可以直接执行Host的命令，操作Host上的文件路径。</p>
<p>下面设置开启对Slave和Framwork的验证，并让Framwork使用低权限的账号，禁止使用root账号。<br>在<code>/etc/default/mesos-master</code>中增加下面的环境变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">authenticate=true</div><div class="line">authenticate_slaves=true</div><div class="line">credentials=/etc/mesos/master-credentials.json</div><div class="line">acls=/etc/mesos/master-acls.json</div></pre></td></tr></table></figure></p>
<p><code>/etc/mesos/master-credentials.json</code>是允许接入Mesos集群的账号和密码（这个与Host的账号系统无关），内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;       </div><div class="line">  &quot;credentials&quot;:[</div><div class="line">    &#123;</div><div class="line">      &quot;principal&quot;:&quot;MesosPrincipal&quot;,</div><div class="line">      &quot;secret&quot;:&quot;f0e4c2f76c58916ec258f246851bea091d14d4247a2fc3e186&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>文件中，</p>
<ul>
<li><code>&quot;principal&quot;:&quot;MesosPrincipal&quot;</code>是用户名，</li>
<li><code>&quot;secret&quot;:&quot;....&quot;</code>是<strong>明文的密码</strong>，是用<code>sha256sum</code>或<code>openssl rand -hex 32</code>计算的一个字符串的哈希值。当然，随便设置的密码都可以，但其中不能有英文的冒号“:”。</li>
</ul>
<p>Slave和Framwork都可以用这个用户名密码。<br>可以在Master设置为不同的Slave和Framwork使用不同的用户名密码，这里为了简便，只使用这一组。</p>
<p><code>/etc/mesos/master-acls.json</code>是访问控制列表，与Host的账号及上面设置的Principal都相关，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;       </div><div class="line">  &quot;run_tasks&quot;:[</div><div class="line">    &#123;</div><div class="line">      &quot;principals&quot;:&#123;&quot;values&quot;:[&quot;MesosPrincipal&quot;]&#125;,</div><div class="line">      &quot;users&quot;:&#123;&quot;values&quot;:[&quot;mesos&quot;]&#125;</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      &quot;principals&quot;:&#123;&quot;type&quot;:&quot;NONE&quot;&#125;,</div><div class="line">      &quot;users&quot;:&#123;&quot;values&quot;:[&quot;root&quot;]&#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个文件将Host的root账号映射到NONE，从而禁止以root账号执行命令；并将MesosPrincipal映射到Host的mesos账号，我们需要在主机上创建该账号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">groupadd -g 1000 mesos</div><div class="line"></div><div class="line"># 对允许mesos账号ssh登录，并且可以使用scp，sftp的机器。添加用户后还需要passwd mesos设置密码</div><div class="line">useradd -d /home/mesos -s /bin/bash  -u 1000 -g 1000 mesos</div><div class="line"></div><div class="line"># 对禁止mesos账号ssh登录的机器。没有设置密码。</div><div class="line">useradd -d /dev/null -s /sbin/nologin -u 1000 -g 1000 mesos</div></pre></td></tr></table></figure></p>
<p>因为要在集群的<strong>多个机器上使用相同账号</strong>，并且还要在<strong>容器中创建相同的账号</strong>，需要保证mesos账号的UID和GID在各机器上是相同的。</p>
<blockquote>
<p>集群的账号管理，应该考虑使用LDAP了。。。</p>
</blockquote>
<p>重启Mesos Master服务：<code>systemctl restart mesos-master</code>。因为没有设置Slave登录的用户名密码，所以这时Slave离线了。</p>
<h2 id="Mesos-Slave的设置-1"><a href="#Mesos-Slave的设置-1" class="headerlink" title="Mesos Slave的设置"></a>Mesos Slave的设置</h2><p>在<code>/etc/default/mesos-slave</code>文件添加下面的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">credential=/etc/mesos/slave-credential-pair</div></pre></td></tr></table></figure></p>
<p>其中<code>/etc/mesos/slave-credential-pair</code>是登录到Master的用户名密码，这里只使用了MesosPrincipal这一个账号。</p>
<blockquote>
<p>注意：按照官方文档的说法，这个账号文件不能以空行结尾，即不能使用VIM等编辑器编辑。<br>而且格式与Master的不同，因为Master可以保存多组用户名密码，但Salve只需要提供一组就可以了。<br>这里使用<code>echo</code>写入值。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo -n &quot;MesosPrincipal f0e4c2f76c58916ec258f246851bea091d14d4247a2fc3e186&quot; &gt; /etc/mesos/slave-credential-pair</div></pre></td></tr></table></figure>
<p>重启Mesos Slave服务：<code>systemctl restart mesos-slave</code>，这时在Mesos Web UI应该就可以看到恢复上线的Slave了。</p>
<h2 id="Marathon的设置-1"><a href="#Marathon的设置-1" class="headerlink" title="Marathon的设置"></a>Marathon的设置</h2><blockquote>
<p>参考：<a href="https://mesosphere.github.io/marathon/docs/framework-authentication.html" target="_blank" rel="external">https://mesosphere.github.io/marathon/docs/framework-authentication.html</a></p>
</blockquote>
<p>在Marathon的Systemd服务配置文件的<code>ExecStart</code>处增加参数，完整的启动命令是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ExecStart=/usr/share/marathon/bin/marathon          \</div><div class="line">    --master n5:5050 --zk zk://n5:2181/marathon     \</div><div class="line">    --enable_features gpu_resources                 \</div><div class="line">    --mesos_authentication                          \</div><div class="line">    --mesos_authentication_principal MesosPrincipal \</div><div class="line">    --mesos_authentication_secret_file /etc/mesos/credential-secret-only</div></pre></td></tr></table></figure></p>
<p>其中文件<code>/etc/mesos/credential-secret-only</code>只包含密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo -n f0e4c2f76c58916ec258f246851bea091d14d4247a2fc3e186 &gt; /etc/mesos/credential-secret-only</div></pre></td></tr></table></figure></p>
<p>重启服务<code>systemctl daemon-reload; systemctl restart marathon</code>，之后可以正常打开Marathon Web UI [<a href="http://10.1.1.5:8080/" target="_blank" rel="external">http://10.1.1.5:8080/</a>] 。<br>还可以在Mesos Web UI的Framworks中看到使用的Principal是MesosPrincipal。</p>
<h2 id="Chronos的设置-1"><a href="#Chronos的设置-1" class="headerlink" title="Chronos的设置"></a>Chronos的设置</h2><blockquote>
<p>参考：<a href="https://mesos.github.io/chronos/docs/configuration.html" target="_blank" rel="external">https://mesos.github.io/chronos/docs/configuration.html</a></p>
</blockquote>
<p>从命令行启动支持GPU的Chronos：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">nohup java -jar /root/chronos/target/chronos-3.0.3-SNAPSHOT.jar         \</div><div class="line">  --master=zk://n5:2181/mesos --http_port=4400                          \</div><div class="line">  --enable_features=gpu_resources                                       \</div><div class="line">  --mesos_authentication_principal=MesosPrincipal                       \</div><div class="line">  --mesos_authentication_secret_file=/etc/mesos/credential-secret-only  \</div><div class="line">  --http_credentials=&quot;ChronosUser:SomePassword&quot; &gt;/dev/null              &amp;</div></pre></td></tr></table></figure></p>
<p>其中使用的<code>/etc/mesos/credential-secret-only</code>跟Marathon的是同一个文件。<br>还设置了登录Chronos Web UI的用户名密码<code>ChronosUser:SomePassword</code>。这个只是针对Chronos的，而且是HTTP Basic验证，聊胜于无吧。</p>
<p>之后再以root账号执行Chronos的作业，将会一直显示<code>Queued</code>。<br>将用户改为<code>&quot;runAsUser&quot;: &quot;mesos&quot;</code>才会正常执行，而且需要root权限的命令会在<code>stderr</code>输出权限错误的信息。</p>
<h1 id="扩展到集群"><a href="#扩展到集群" class="headerlink" title="扩展到集群"></a>扩展到集群</h1><p>集群中可以设置多个Zookeeper节点，多个Master节点，以达到高可用（需是单数个节点）。<br>需要在每个机器上创建mesos这个账号，并保证UID，GID与其它机器相同，并将Master或Slave相关的配置文件等拷贝到对应的机器上。<br>Marathon和Chronos框架只需在某一台机器上启动即可，也可以启动多个实例，设置高可用模式。</p>
<h1 id="文件服务器设置"><a href="#文件服务器设置" class="headerlink" title="文件服务器设置"></a>文件服务器设置</h1><p>为了方便其它用户使用mesos账号拷贝文件到集群，需要搭建一个文件服务器。<br>集群已经把所有机器的硬盘加入了<a href="https://wiki.centos.org/SpecialInterestGroup/Storage/gluster-Quickstart" target="_blank" rel="external">Gluster分布式文件系统</a>，路径是<code>/gluster/volume2</code>，在其中新建文件夹<code>/gluster/volume2/data</code>作为用户上传文件的工作目录。<br>所有机器上都能同步看到这个相同的文件路径。</p>
<blockquote>
<p>GlusterFS有Linux系统的Native Client，可以<a href="https://docs.gluster.org/en/latest/Administrator%20Guide/SSL/" target="_blank" rel="external">使用SSL/TLS安全验证</a> 。由于不支持MacOS和Windows，且设置不方便，故不使用这种方式。</p>
</blockquote>
<h2 id="SFTP-【X】"><a href="#SFTP-【X】" class="headerlink" title="SFTP 【X】"></a>SFTP 【X】</h2><p>本来想允许某台机器的mesos账号ssh登录，这样也就默认开启了scp和sftp，可以使用Filezilla等FTP工具传文件。<br>但是，又想限制SFTP只能读写自己的<code>$HOME</code>，比如把mesos的<code>$HOME</code>设置为<code>/gluster/volume2/data</code>，只能读写这个文件夹。<br>OpenSSH确实可以<a href="https://bensmann.no/restrict-sftp-users-to-home-folder" target="_blank" rel="external">通过<code>chroot</code>限制某个组的用户 <strong>只能读</strong> 它的$HOME（或某个特定的文件夹）</a> 。<br>又来了但是，<code>chroot</code>后，对这个用户而言，整个文件系统就只有<code>$HOME</code>下的那些文件了，没有<code>/bin</code>、<code>/usr</code>等，也就无法执行<code>ssh</code>或者<code>scp</code>；而<code>sftp</code>还可以用，是因为设置中改用了OpenSSH内置的sftp功能，而不是外部的sftp程序（ <code>/usr/libexec/openssh/sftp-server</code>）；<br>而且必须把<code>$HOME</code>的owner设置为<code>root</code>，权限只能是<code>755</code>或<code>750</code>，就是说即便把owner group改为mesos，它也只能对自己的<code>$HOME</code>有读权限，但 <strong>不能写</strong>；</p>
<p>虽然可以在<code>$HOME</code>新建子目录用于mesos读写，但感觉还是不爽，试试别的方案。</p>
<h2 id="NFS-on-Gluster-【X】"><a href="#NFS-on-Gluster-【X】" class="headerlink" title="NFS on Gluster 【X】"></a>NFS on Gluster 【X】</h2><p>NFS是 *nix 系统上的文件共享服务。Linux，Windows和MacOS也都支持挂载NFS。问题是<a href="http://joshuawise.com/kerberos-nfs" target="_blank" rel="external">需要额外的组件（Kerberos）才能支持用户登录验证</a>，否则是公开访问的！</p>
<p>Gluster有专门的NFS组件<code>nfs-ganesha</code>，比使用系统默认的NFS组件好一点。不使用Kerberos的<code>nfs-ganesha</code>设置过程如下：</p>
<blockquote>
<p>参考：</p>
<ul>
<li><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Storage/2.1/html/Administration_Guide/gluster-nfs_and_kernel-nfs_services.html" target="_blank" rel="external">Manually Configuring nfs-ganesha Exports - Red Hat document</a></li>
<li><a href="http://docs.gluster.org/en/latest/Administrator%20Guide/NFS-Ganesha%20GlusterFS%20Integration/" target="_blank" rel="external">Configuring NFS-Ganesha over GlusterFS</a></li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install -y glusterfs-ganesha nfs-ganesha nfs-ganesha-gluster</div><div class="line">/usr/libexec/ganesha/ganesha.nfsd -N NIV_MAJ  # 修改Log级别，减少日志量</div></pre></td></tr></table></figure>
<p>修改配置文件<code>/etc/ganesha/ganesha.conf</code>，其中：</p>
<ul>
<li>Gluster卷的路径是<code>/gluster/volume2</code>，共享的是其子目录<code>/gluster/volume2/data</code>；</li>
<li>映射到的 NFS 路径是<code>10.1.1.5:/data</code>，所有客户端都映射到 mesos 账号的UID 1000和GID 1000；</li>
<li>NFS 的版本是v3，没有用v4。</li>
</ul>
<p>完整内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">EXPORT&#123;</div><div class="line">      Export_Id = 1;</div><div class="line">      Path = &quot;/data&quot;;</div><div class="line">      FSAL &#123;</div><div class="line">           name = GLUSTER;</div><div class="line">           hostname=&quot;localhost&quot;;</div><div class="line">           volume=&quot;volume2&quot;;</div><div class="line">           volpath=&quot;/data&quot;;</div><div class="line">           &#125;</div><div class="line">      Access_type = RW;</div><div class="line">      Disable_ACL = true;</div><div class="line">      Squash=&quot;All_Anonymous&quot;;</div><div class="line">      Pseudo=&quot;/data&quot;;</div><div class="line">      Protocols = &quot;3&quot;;</div><div class="line">      Transports = &quot;UDP&quot;,&quot;TCP&quot;;</div><div class="line">      SecType = &quot;sys&quot;;</div><div class="line">      </div><div class="line">      anonymous_uid = 1000;</div><div class="line">      anonymous_gid = 1000;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">NFS_Core_Param &#123;</div><div class="line">    NSM_Use_Caller_Name = true;</div><div class="line">    Clustered = false;</div><div class="line">    Rquota_Port = 875;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gluster volume set volume2 features.cache-invalidation on</div><div class="line">systemctl restart nfs-ganesha</div></pre></td></tr></table></figure></p>
<p>执行<code>showmount -e localhost</code>查看是否正常，输出中应包含 <code>/data (everyone)</code></p>
<p>在客户端挂载NFS到<code>/mnt</code> ： <code>sudo mount -t nfs 10.1.1.5:/data /mnt</code>，卸载<code>sudo umount -f /mnt</code>。</p>
<p>NFSv4的话，如果客户端与服务器的域名不一致，会把用户映射为<code>nobody</code>和<code>nogroup</code>；<br>NFSv3则会根据服务器的UID和GID，在客户端找有没有对应的账号：比如服务端用的mesos账号，UID是1000，碰巧客户端存在UID 1000的账号sosem，那就会显示sosem，没有找到对应的就直接显示UID或GID。<br>如果服务端的<strong>匿名用户对共享文件有读写权限</strong>，客户端总是可以在本机执行<code>sudo</code>命令随意读写远程的NFS文件，因为客户端的操作最终都是以匿名用户映射的账号在服务器执行的。<br>而为了能上传文件，就得开放写权限。<br>总之，NFS本身的安全机制实在是鸡肋，另选其它方案吧。</p>
<h2 id="Samba-SMB-CIFS文件共享"><a href="#Samba-SMB-CIFS文件共享" class="headerlink" title="Samba SMB/CIFS文件共享"></a>Samba SMB/CIFS文件共享</h2><p>Samba 文件共享非常方便（参考<a href="/misc/2016/remote/">局域网的远程操作</a>对应小节），</p>
<ul>
<li>Samba服务的配置很方便，自带用户验证，可以方便地设置共享目录、权限、用户（独立的密码）；</li>
<li>映射成网络驱动器就跟读写本地硬盘体验一样；</li>
<li>Linux、MacOS、Windows都自带了客户端，可以直接挂载，Android手机也有ES文件浏览器App支持挂载。</li>
</ul>
<p>但是，2017年5月份的勒索病毒WanaCrypt会通过445这个文件共享的默认端口攻击Windows机器，于是 <strong>网络管理员禁止了445端口</strong>。<br>好在可以修改Samba服务的默认端口，绕过封锁。Linux、MacOS和Android的ES文件浏览器都支持修改端口号。<br>但是，除了Windows只能使用445端口，无法修改。</p>
<p>设置步骤在<a href="/misc/2016/remote/">局域网的远程操作</a>对应小节介绍过，这里再简单重复一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y samba</div></pre></td></tr></table></figure></p>
<p>修改 <code>/etc/samba/smb.conf</code>，完整的内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># Run &apos;testparm&apos; to verify the config is correct after you modified it.</div><div class="line">[global]</div><div class="line">  workgroup = SAMBA</div><div class="line">  security = user</div><div class="line">  passdb backend = tdbsam</div><div class="line">  printing = cups</div><div class="line">  printcap name = cups</div><div class="line">  load printers = no</div><div class="line">  cups options = raw</div><div class="line">  smb ports = 4455</div><div class="line"></div><div class="line">[data]</div><div class="line">  comment = mesos work path</div><div class="line">  path = /gluster/volume2/data</div><div class="line">  writeable = yes</div><div class="line">  create mask = 0664</div><div class="line">  directory mask = 0775</div><div class="line">; browseable = yes # 在Windows资源管理器不可见，只能通过输入完整的地址来访问</div><div class="line">  valid users = mesos</div></pre></td></tr></table></figure></p>
<p>然后设置mesos在Samba系统的密码：<code>smbpasswd -a mesos</code>。<br>之后启动smbd服务：<code>systemctl enable smb; systemctl start smb</code>。</p>
<p>Linux客户端需要执行<code>yum install -y samba-client cifs-utils</code> 安装必要的软件。<br>以挂载到<code>/mnt</code>为例，命令是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo mount -t cifs //10.1.1.5/data /mnt -o user=mesos,pass=MesosSambaPassword,port=4455,rw,iocharset=utf8</div></pre></td></tr></table></figure></p>
<p>或写入<code>/etc/fstab</code>末尾，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">//10.1.1.5/data /mnt cifs user=mesos,pass=MesosSambaPassword,port=4455,rw,iocharset=utf8 0 0</div></pre></td></tr></table></figure></p>
<p>这样系统启动后就会自动挂载了，或执行<code>sudo mount -a</code>手动挂载<code>/etc/fstab</code> 。</p>
<p>可以在Linux桌面的文件管理器<strong>地址栏</strong>，或MacOS Finder的 <strong>连接服务器 Command+K</strong> 对话框输入<code>smb://10.1.1.5:4455/data</code>来访问Samba共享文件夹（会弹出账号密码窗口）。<br>Windows的地址格式是<code>\\10.1.1.5\data</code>，但由于不支持非445的端口号，所以无法访问。。。</p>
<h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p>Windows和Linux客户端可以通过普通的FTP来上传文件，文件管理器可以直接打开FTP地址，也可以安装Filezilla。<br>MacOS不能直接在Finder（访达）打开FTP站点，需要安装Filezilla。</p>
<p>服务端，在CentOS服务器执行<code>yum install -y vsftpd</code>，配置文件是<code>/etc/vsftpd/vsftpd.conf</code>，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">anonymous_enable=NO</div><div class="line">local_enable=YES</div><div class="line">write_enable=YES</div><div class="line">local_umask=022</div><div class="line">dirmessage_enable=YES</div><div class="line">xferlog_enable=YES</div><div class="line">connect_from_port_20=YES</div><div class="line">xferlog_std_format=YES</div><div class="line">chroot_local_user=YES</div><div class="line">chroot_list_enable=YES</div><div class="line">chroot_list_file=/etc/vsftpd/chroot_list</div><div class="line">allow_writeable_chroot=YES</div><div class="line">listen=NO</div><div class="line">listen_ipv6=YES</div><div class="line">pam_service_name=vsftpd</div><div class="line">userlist_enable=YES</div><div class="line">tcp_wrappers=YES</div></pre></td></tr></table></figure></p>
<p>其中限制用户只能读写自己的<code>$HOME</code>。执行<code>touch /etc/vsftpd/chroot_list</code>建一个空的占位文件。<br>需要设置Host的mesos账号：</p>
<ul>
<li><code>$HOME</code>设置为<code>/gluster/volume2/data</code>，并设置为owner，有读写权限;</li>
<li>还要设置<code>mesos</code>账号的密码 <code>passwd mesos</code>。</li>
</ul>
<p>FTP是不加密的，使用主机上的账号和密码登录，可以写在地址里，即<br><code>ftp://mesos:MesosHostPassword@10.1.1.5</code>，<br>或<br><code>ftp://mesos@10.1.1.5</code>，在弹出的窗口输入密码。</p>
<h1 id="Chronos在容器中执行GPU作业"><a href="#Chronos在容器中执行GPU作业" class="headerlink" title="Chronos在容器中执行GPU作业"></a>Chronos在容器中执行GPU作业</h1><p>前面使用Chronos提交了基于Host命令的作业，更好的办法是把运行环境打包成容器，以便于部署和管理。<br>我们创建了一个<a href="https://github.com/icsnju/dlkit/blob/master/Dockerfile" target="_blank" rel="external"><code>icsnju/dlkit</code>的Docker镜像</a>，然而由于网络原因，还有镜像本身太大了，在Docker Hub上没有构建成功，后来是在VPS上构建的，再Push到我们用<a href="https://github.com/vmware/harbor" target="_blank" rel="external">Harbor</a>搭建的本地镜像仓库。</p>
<p>为了配合Mesos使用低权限的mesos账号执行任务，需要在Docker镜像中也添加同名，同UID和GID的mesos用户，将其设置为可免输密码执行<code>sudo</code>命令，并将默认用户切换为mesos。<br>Dockerfile内容如下，构建出的镜像tag设为<code>local/dlkit:mesos</code>，下面会用到这个镜像。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">FROM local/dlkit:latest</div><div class="line">RUN  echo &apos;deb http://mirrors.ustc.edu.cn/ubuntu/ xenial main restricted universe multiverse&apos; &gt; /etc/apt/sources.list ; \</div><div class="line">     rm /etc/apt/sources.list.d/*      ; \</div><div class="line">     apt-get update                    ; \</div><div class="line">     apt-get install -y sudo           ; \</div><div class="line">     apt-get clean; apt-get autoremove ; \</div><div class="line">     rm -rf /var/lib/apt/lists/*       ; \</div><div class="line">     groupadd -g 1000 mesos            ; \</div><div class="line">     useradd  -m -u 1000 -g 1000 mesos ; \</div><div class="line">     echo &quot;mesos ALL=(ALL) NOPASSWD: ALL&quot; &gt; /etc/sudoers.d/mesos</div><div class="line"></div><div class="line">USER mesos</div></pre></td></tr></table></figure></p>
<p>下面使用<a href="https://github.com/keras-team/keras/blob/master/examples/mnist_cnn.py" target="_blank" rel="external">Keras的MNIST CNN示例</a><br>Chronos提交GPU的容器作业配置文件内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;mnist-cnn-demo&quot;,</div><div class="line">  &quot;command&quot;: &quot;cd /data/mnist ; env; python mnist_cnn.py | tee out-`date +%Y%m%dT%H%M%S`.txt&quot;,</div><div class="line">  &quot;shell&quot;: true,</div><div class="line">  &quot;executor&quot;: &quot;&quot;,</div><div class="line">  &quot;executorFlags&quot;: &quot;&quot;,</div><div class="line">  &quot;taskInfoData&quot;: &quot;&quot;,</div><div class="line">  &quot;retries&quot;: 0,</div><div class="line">  &quot;owner&quot;: &quot;&quot;,</div><div class="line">  &quot;ownerName&quot;: &quot;&quot;,</div><div class="line">  &quot;description&quot;: &quot;&quot;,</div><div class="line">  &quot;cpus&quot;: 10,</div><div class="line">  &quot;disk&quot;: 1000,</div><div class="line">  &quot;mem&quot;: 10240,</div><div class="line">  &quot;gpus&quot;: 1,</div><div class="line">  &quot;disabled&quot;: false,</div><div class="line">  &quot;softError&quot;: false,</div><div class="line">  &quot;dataProcessingJobType&quot;: false,</div><div class="line">  &quot;fetch&quot;: [],</div><div class="line">  &quot;uris&quot;: [],</div><div class="line">  &quot;environmentVariables&quot;: [],</div><div class="line">  &quot;arguments&quot;: [],</div><div class="line">  &quot;highPriority&quot;: false,</div><div class="line">  &quot;runAsUser&quot;: &quot;mesos&quot;,</div><div class="line">  &quot;concurrent&quot;: false,</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;MESOS&quot;,</div><div class="line">    &quot;image&quot;: &quot;local/dlkit:mesos&quot;,</div><div class="line">    &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">    &quot;networkInfos&quot;: [],</div><div class="line">    &quot;volumes&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;hostPath&quot;: &quot;/gluster/volume2/data&quot;,</div><div class="line">        &quot;containerPath&quot;: &quot;/data&quot;,</div><div class="line">        &quot;mode&quot;: &quot;RW&quot;</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;forcePullImage&quot;: false,</div><div class="line">    &quot;parameters&quot;: []</div><div class="line">  &#125;,</div><div class="line">  &quot;constraints&quot;: [],</div><div class="line">  &quot;schedule&quot;: &quot;R1//P1Y&quot;,</div><div class="line">  &quot;scheduleTimeZone&quot;: &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，</p>
<ul>
<li><code>&quot;command&quot;: &quot;cd /data/mnist ; env; python mnist_cnn.py | tee out-`date +%Y%m%dT%H%M%S`.txt&quot;</code> 为便于排错，用<code>env; pwd</code>来输出环境信息，实际计算结果则重定向到<code>result`date +%Y%m%dT%H%M%S`.txt&quot;</code>文件中；</li>
<li><code>&quot;cpus&quot;: 10,  &quot;disk&quot;: 1000,  &quot;mem&quot;: 10240,  &quot;gpus&quot;: 1</code>，这是为容器分配的资源，如果机器上有2个GPU，那么最多可以申请2个，申请更多的话，Job会一直排队等待资源Offer，无法执行。CPU和内存资源也要多申请一些，防止OOM；</li>
<li><code>&quot;runAsUser&quot;: &quot;mesos&quot;</code>，以容器内的mesos账号执行命令；</li>
<li><code>container</code>一节设置了使用的镜像，类型必须写成<code>MESOS</code>，而不能是<code>DOCKER</code>；</li>
<li>还要在<code>volumes</code>中设置Host上传文件的路径到容器路径的映射，路径名中不能有<code>-</code>，否则无法挂载，导致容器无法启动。</li>
</ul>
<p>提交后就可以在容器中执行GPU作业了。</p>
<blockquote>
<p>在容器中执行任务已经支持了运行时的隔离，但文件服务使用的是同一个目录，没有隔离。<br>其实只要额外开发一个提交任务的页面，不让用户设置路径名，然后为每个用户设置不同的文件路径，就可以支持多用户的隔离了。</p>
<p>PS，Mesos是Docker之前开发的，之后也没有充分利用Docker的隔离能力，设置上有点麻烦。</p>
</blockquote>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/misc/2018/book-list/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          书单
        
      </div>
    </a>
  
  
    <a href="/cloud/2017/setup-tensorflow-gpu-centos7/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">CentOS 7 安装TensorFlow GPU深度学习环境</div>
    </a>
  
</nav>

  
</article>

</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
  			<li><a href="https://github.com/ying-zhang" target="_blank"><i class="icon icon-github"></i></a></li>
  		
			
  			<li><a href="/atom.xml" target="_blank"><i class="icon icon-tag"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2018 Ying ZHANG 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/hejianxian/hexo-theme-jane/" target="_blank">Jane</a>
		- Project Source at <a href="https://github.com/ying-zhang/ying-zhang.github.io/" target="_blank">Github</a>
	</div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com/ying-zhang" class="mobile-nav-link">Github</a>
  
    <a href="/atom.xml" class="mobile-nav-link">RSS</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>