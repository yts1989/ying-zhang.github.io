<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>局域网内的远程操作 | Ying的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一些基础的远程操作，包括ssh，共享文件，远程桌面。">
<meta property="og:type" content="article">
<meta property="og:title" content="局域网内的远程操作">
<meta property="og:url" content="https://ying-zhang.github.io/misc/2016/remote/index.html">
<meta property="og:site_name" content="Ying的博客">
<meta property="og:description" content="一些基础的远程操作，包括ssh，共享文件，远程桌面。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ying-zhang.github.io/img/xshell-ui.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/xshell-prop.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/sftp.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/xshell-key.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/win-share.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/smb.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/win-mstsc.png">
<meta property="og:image" content="https://ying-zhang.github.io/img/win-mstsc-svr.png">
<meta property="og:updated_time" content="2017-10-30T02:47:45.881Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="局域网内的远程操作">
<meta name="twitter:description" content="一些基础的远程操作，包括ssh，共享文件，远程桌面。">
<meta name="twitter:image" content="https://ying-zhang.github.io/img/xshell-ui.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <div class="outer">
        <section id="main"><article id="post-remote" class="article article-type-post" itemscope itemprop="blogPost">
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      局域网内的远程操作
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/misc/2016/remote/" class="article-date">
  <time datetime="2016-09-17T16:00:00.000Z" itemprop="datePublished">2016-09-18</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/misc/">misc</a>
  </div>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>一些基础的远程操作，包括ssh，共享文件，远程桌面。</p>
<a id="more"></a>
<hr>
<!-- TOC -->
<ul>
<li><a href="#linux%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%EF%BC%88ssh%EF%BC%89">Linux远程执行命令（ssh）</a><ul>
<li><a href="#linux%E4%B8%8B%E8%AE%BE%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8ssh">Linux下设置和使用ssh</a></li>
<li><a href="#windows%E5%AE%89%E8%A3%85%E5%92%8C%E8%AE%BE%E7%BD%AExshell%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AF%86%E7%A0%81ssh%E7%99%BB%E5%BD%95">Windows安装和设置xshell，使用密码ssh登录</a></li>
<li><a href="#scp">scp</a></li>
<li><a href="#sftp">sftp</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AEssh%E4%BD%BF%E7%94%A8%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95">设置ssh使用密钥登录</a><ul>
<li><a href="#%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%AF%B9">生成密钥对</a></li>
<li><a href="#%E5%88%86%E5%8F%91%E5%AF%86%E9%92%A5%E5%AF%B9">分发密钥对</a><ul>
<li><a href="#ssh-copy-id">ssh-copy-id</a></li>
<li><a href="#%E5%A4%8D%E5%88%B6%E5%AF%86%E9%92%A5%E6%96%87%E6%9C%AC">复制密钥文本</a></li>
</ul>
</li>
<li><a href="#ssh-config%E8%AE%BE%E7%BD%AE">ssh config设置</a></li>
<li><a href="#%E8%B8%A2%E5%87%BAssh%E4%BC%9A%E8%AF%9D">踢出ssh会话</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%BF%9C%E7%A8%8B%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%EF%BC%88smbcifs%EF%BC%89">远程共享文件（SMB/CIFS）</a><ul>
<li><a href="#samba%E8%AE%BF%E9%97%AEwindows%E6%8F%90%E4%BE%9B%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6">Samba访问Windows提供的共享文件</a></li>
<li><a href="#windows%E8%AE%BF%E9%97%AEsamba%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6">Windows访问Samba的共享文件</a></li>
<li><a href="#%E6%9B%B4%E6%94%B9samba%E7%9A%84%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3%E5%8F%B7">更改Samba的默认端口号</a></li>
</ul>
</li>
<li><a href="#%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2">远程桌面</a><ul>
<li><a href="#mstsc">mstsc</a></li>
<li><a href="#vnc">vnc</a></li>
<li><a href="#%E5%85%B6%E5%AE%83">其它</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p>这里简单介绍局域网中Windows与Linux系统之间的一些基本远程操作，包括远程执行命令（<code>ssh</code>），共享文件（<code>Samba</code>）和远程桌面（<code>mstsc</code>和<code>vnc</code>）。<br>远程操作一般是“服务器-客户端”模式，有的服务程序或客户端是操作系统内置的，开箱即用，有的程序则需要手动安装。</p>
<p>为了方便配置，<strong>建议关闭系统的防火墙</strong>。下面例子使用的远程Linux主机是Ubuntu 16.04，IP是<code>10.1.1.5</code>，用户名<code>ying</code>；Windows的IP是<code>10.1.1.1</code>，用户名也是<code>ying</code>。</p>
<h1 id="Linux远程执行命令（ssh）"><a href="#Linux远程执行命令（ssh）" class="headerlink" title="Linux远程执行命令（ssh）"></a>Linux远程执行命令（ssh）</h1><p>ssh（<a href="https://en.wikipedia.org/wiki/Secure_Shell" target="_blank" rel="external">Secure Shell</a>）通过加密的网络通道在客户端和服务器之间传递命令及其输出。<br>在ssh之前，远程执行命令是通过<code>telnet</code>或<code>rsh</code>等程序实现的，数据是明文传输的，缺乏安全性。ssh提供了一个在网络上认证用户和加密数据的通道，执行命令是直接使用的系统内置的shell。<br>可以在ssh提供的加密通道上完成其它网络通信：如<code>scp</code>是在ssh加密通道上实现的远程拷贝（<code>rcp</code>）；<code>sftp</code>是在ssh加密通道上实现的<code>ftp</code>；<code>git</code>也有使用ssh加密通道传输文件的模式。<br>对于Linux这种主要通过shell命令行交互的系统来说，使用ssh远程登录到服务器上，就跟直接在机器上敲命令就没什么区别了。</p>
<h2 id="Linux下设置和使用ssh"><a href="#Linux下设置和使用ssh" class="headerlink" title="Linux下设置和使用ssh"></a>Linux下设置和使用ssh</h2><p>Linux系统的ssh服务程序是<code>OpenSSH Server</code>，执行命令<code>sudo apt install openssh-server</code>。<br>安装过程中会将ssh服务程序（<code>sshd</code>）添加为开机启动的系统服务，默认设置允许当前用户通过密码登录ssh。</p>
<blockquote>
<p>查看SSH Server状态，执行<code>systemctl status sshd</code><br>启动，停止或重启服务，执行<code>sudo systemctl start/stop/restart sshd</code></p>
</blockquote>
<p>一般Linux系统都内置了ssh客户端，执行<br><code>ssh 用户名@主机名或IP</code><br>登录到远程主机（如果用户名与当前登录的用户名相同，可以省略）。<br>登录到本机的命令是<code>ssh localhost</code><br>第一次登录某个主机会提示是否 <strong>信任</strong> 该主机，需要输入<code>yes</code>，之后才会提示输入远程主机的登录密码。</p>
<blockquote>
<p>修改<code>/etc/ssh/ssh_config</code>，将其中<code>#   StrictHostKeyChecking ask</code> 改为 <code>StrictHostKeyChecking no</code>，这样在第一次登录时就不会询问是否要信任该主机了。</p>
</blockquote>
<p>如果登录到远程主机只是执行一两条命令，可执行<br><code>ssh 用户名@主机名或IP 命令</code><br>当然，每次还是需要输入密码，参考下面的设置密钥登录后就方便多了。</p>
<h2 id="Windows安装和设置xshell，使用密码ssh登录"><a href="#Windows安装和设置xshell，使用密码ssh登录" class="headerlink" title="Windows安装和设置xshell，使用密码ssh登录"></a>Windows安装和设置xshell，使用密码ssh登录</h2><p>Windows目前没有内置的ssh客户端，可以安装Putty、SecureCRT、xshell等ssh客户端软件，或者使用Cygwin/MinGW，git（包含MinGW），Bash on Windows等附带的ssh命令。</p>
<blockquote>
<p>Windows版的<code>git</code>包含一个简化版<code>MinGW</code>，将<code>&lt;git安装目录&gt;\usr\bin</code>这个路径添加到Windows的<code>Path</code>环境变量，就可以在Windows的命令窗口执行<code>ssh</code>，<code>scp</code>及其它很多Linux命令了。<br><code>MinGW</code> 中也包含SSH Server程序<code>sshd</code>，不过估计很少会登录到Windows执行命令行操作吧。</p>
</blockquote>
<p>从官网下载并安装 <a href="http://www.netsarang.com/download/down_xsh.html" target="_blank" rel="external">xshell</a> （需要注册一个免费的账号，选择免费的Home/School许可），也可以在百度搜索“xshell”，第一条结果即是，注意要选择 <strong>普通下载</strong>。</p>
<p>启动xshell后，可以直接执行<code>ssh ying@10.1.1.5</code>，会提示输入密码，首次连接也会提示“未知的主机密钥”，选择保存即可。<br><img src="/img/xshell-ui.png" alt=""></p>
<blockquote>
<p>工具栏的打开会话按钮，可以从其中选择某个会话，也可以直接在xshell中执行<code>open &lt;会话名&gt;</code>。<br>工具栏的那个带小齿轮的按钮是“默认会话属性”，修改其中的设置会影响新建的会话。<br>每个会话即<code>&lt;用户文档&gt;\NetSarang\Xshell\Sessions</code>下的一个配置文件，会话也可以复制后修改。</p>
</blockquote>
<p>为方便后续使用，可以为这个虚拟机创建一个会话。单击工具栏的“新建”按钮，在打开的 <strong>“会话属性”</strong> 对话框中</p>
<ul>
<li>在“连接” 输入主机 <code>10.1.1.5</code>，在用户身份验证中选择方法为Password，输入用户名 <code>ying</code> 和 密码；</li>
<li>在“终端” 修改“编码”为UTF-8；</li>
<li>在“外观” 修改终端字体和配色方案，我比较习惯黑底绿字的配色，使用Consolas字体，使用闪烁的光标。</li>
</ul>
<p><img src="/img/xshell-prop.png" alt=""></p>
<blockquote>
<p>注意：Windows的快捷键与Linux终端的快捷键存在冲突，如“复制”<code>Ctrl+C</code>对应的是中断当前命令。<br>xshell中默认“复制”、“粘贴”的快捷键是<code>Ctrl+Ins</code>，<code>Shift+Ins</code>，而不是<code>Ctrl+C</code>，<code>Ctrl+V</code>。<br>可以打开 “工具”-&gt;“选项”，“键盘和鼠标”选项卡，“按键对应”-&gt;“编辑”，将其修改为<code>Ctrl+C</code>，<code>Ctrl+V</code>，而原来Linux终端的快捷键需要加<code>Shift</code>，如中断当前命令的<code>Ctrl+C</code>变成了<code>Ctrl+Shift+C</code>。</p>
</blockquote>
<h2 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h2><p>通过ssh加密的通道传输文件。文件路径格式为<code>用户名@主机名或IP:主机上的路径</code>。注意，Windows文件路径中的盘符<code>C:\</code>变成了<code>/c/</code>。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">scp ying@10.1.1.5:/home/ying/.ssh/id_rsa.pub /c/users/ying/.ssh/</div></pre></td></tr></table></figure></p>
<h2 id="sftp"><a href="#sftp" class="headerlink" title="sftp"></a>sftp</h2><p><code>OpenSSH Server</code>内置了一个<code>sftp</code>服务器，会随<code>sshd</code>服务自动启动。我们还需要一个<code>sftp</code>的客户端即可传送文件。<br>这里使用图形界面的，跨平台的，免费的，开源的<a href="https://filezilla-project.org/download.php?type=client" target="_blank" rel="external">Filezilla</a>。下载并安装后，在“快速连接”工具栏输入主机<code>sftp://10.1.1.5</code>，及用户名 <code>ying</code> 和密码，端口为22，单击“快速连接”，然后就可以进行文件传输和管理了。<br><img src="/img/sftp.png" alt=""></p>
<p>Android上的<code>ES文件浏览器</code>也支持<code>sftp</code>（还支持下面介绍的smb局域网文件共享）。</p>
<h2 id="设置ssh使用密钥登录"><a href="#设置ssh使用密钥登录" class="headerlink" title="设置ssh使用密钥登录"></a>设置ssh使用密钥登录</h2><p>更安全而且方便的ssh登录方式是使用密钥对(key)。密钥对包含公钥和私钥，其实是两个很长的整数（被编码为字符串）。比如采用<code>rsa</code>算法，公钥和私钥分别保存在两个 <strong>文本</strong> 文件<code>id_rsa.pub</code>和<code>id_rsa</code>中。</p>
<ul>
<li>公钥<code>id_rsa.pub</code>保存在要登录的目标机器上（服务器，Github等），</li>
<li>私钥<code>id_rsa</code>保存在 <strong>发起</strong> 登录的机器上（客户端），私钥要妥善保管，防止泄露。</li>
</ul>
<p>Linux主机的密钥对默认保存在<code>~/.ssh/</code>目录。<br>Windows是<code>C:\Users\&lt;Win用户名&gt;\.ssh\</code>目录。在图形界面的文件管理器中不能创建以<code>.</code>开头的文件夹，需要在命令窗口操作：打开Windows的命令窗口（<code>Win键+X，C</code>），执行命令<code>mkdir C:\Users\&lt;Win用户名&gt;\.ssh</code>。</p>
<h3 id="生成密钥对"><a href="#生成密钥对" class="headerlink" title="生成密钥对"></a>生成密钥对</h3><p>因为加密算法是公开的，有多种工具可以生成密钥。<br>对Linux或MinGW，执行<code>ssh-keygen -t rsa -P &quot;&quot;</code> ，会在<code>~/.ssh/</code>生成密钥对<code>id_rsa.pub</code>和<code>id_rsa</code>。</p>
<p>xshell也可以生成密钥对：</p>
<ul>
<li>打开 “工具”-&gt; “新建用户密钥生成向导” 或 “工具”-&gt; “用户密钥管理者” -&gt; “生成” 生成一个密钥类型为RSA的密钥，向导的最后一步会显示公钥，可以将其保存起来；</li>
<li>选择刚创建的密钥，单击“导出”按钮，保存私钥，默认的格式与OpenSSH相同；</li>
<li>选择刚创建的密钥，单击“属性”按钮，在“公钥”选项卡中保存公钥。</li>
</ul>
<p><img src="/img/xshell-key.png" alt=""></p>
<h3 id="分发密钥对"><a href="#分发密钥对" class="headerlink" title="分发密钥对"></a>分发密钥对</h3><p>要启用密钥，需清除其它用户访问私钥的权限（600），并公钥拷贝到远程目标Linux主机的<code>.ssh/authorized_keys</code>文件中。<br>分发密钥对其实就是在在Windows和Linux之间传送文件，可以使用上面提到的<code>scp</code>和<code>sftp</code>，也可以参考后面要介绍的smb文件共享；或者更复杂一些，搭建一个Web服务器，把文件放到上面，在Linux执行<code>wget</code>或<code>curl</code>命令下载，Windows可以通过浏览器下载。下面还有另外两种方法。</p>
<h4 id="ssh-copy-id"><a href="#ssh-copy-id" class="headerlink" title="ssh-copy-id"></a>ssh-copy-id</h4><p>执行命令<code>ssh-copy-id -i 公钥文件 用户名@主机名或IP</code>，将公钥拷贝到远程Linux主机的<code>/home/&lt;用户名&gt;/.ssh/authorized_keys</code>文件中。当然，这个命令需要用密码访问远程主机。</p>
<h4 id="复制密钥文本"><a href="#复制密钥文本" class="headerlink" title="复制密钥文本"></a>复制密钥文本</h4><p>如将Linux主机上生成的私钥<code>id_rsa</code>拷贝到Windows上：</p>
<ul>
<li>使用xshell用密码登录到Linux，执行<code>cat ~/.ssh/id_rsa</code>，输出私钥的内容，复制输出的文字。</li>
<li>在Windows文件管理器中打开路径<code>C:\Users\&lt;Win用户名&gt;\.ssh</code>，在其中创建一个名为<code>id_rsa.txt</code>的文本文件，将上一步复制的文字粘贴进去，然后把文件名的<code>.txt</code>扩展名去掉，即改为<code>id_rsa</code>。</li>
</ul>
<p>可以参考上面的方式将Windows上生成的公钥拷贝到远程Linux主机上。因为还要从远程Linux主机上执行<code>git</code>、<code>ssh</code>等命令，所以也要把私钥放拷过去。当然，也可以使用不同的密钥对。</p>
<h3 id="ssh-config设置"><a href="#ssh-config设置" class="headerlink" title="ssh config设置"></a>ssh config设置</h3><p>在<code>~/.ssh/config</code>文件中可以设置多个远程主机的别名，地址，端口，用户名和密钥，简化ssh命令。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Host   别名</div><div class="line">    HostName 主机名或IP</div><div class="line">    Port     端口</div><div class="line">    User     用户名</div><div class="line">    IdentityFile   私钥文件</div><div class="line"></div><div class="line">Host u</div><div class="line">    Hostname  10.1.1.5</div><div class="line">    Port      22</div><div class="line">    User      ying</div><div class="line"></div><div class="line">Host          10.1.1.6</div><div class="line">Port          2222</div><div class="line"></div></pre></td></tr></table></figure></p>
<p>这样就可以直接执行<code>ssh 别名</code>登录指定的主机，而且不同的主机可以使用不同的端口，用户，密钥配置。别名还可以用在<code>scp</code>的路径中。</p>
<h3 id="踢出ssh会话"><a href="#踢出ssh会话" class="headerlink" title="踢出ssh会话"></a>踢出ssh会话</h3><p>查看在线用户：<code>w</code> 或 <code>who</code>，两者输出格式有所不同。<br>查看自己的连接信息：<code>who am i</code>。<br>踢出其它会话：<code>pkill -9 -t pts/1</code>，其中<code>pts/1</code>是被踢会话的终端。</p>
<h1 id="远程共享文件（SMB-CIFS）"><a href="#远程共享文件（SMB-CIFS）" class="headerlink" title="远程共享文件（SMB/CIFS）"></a>远程共享文件（SMB/CIFS）</h1><p>“共享文件”（<a href="https://en.wikipedia.org/wiki/Server_Message_Block" target="_blank" rel="external">Server Message Block，SMB</a> )，改进的版本称为Common Internet File System，CIFS），是Windows上为局域网用户提供的远程访问文件的功能。Windows内置了smb的服务程序和客户端。<br>Samba是Linux上实现SMB/CIFS协议的开源服务程序及客户端。<br>Linux上与SMB/CIFS功能是类似的是“网络文件系统”（<a href="https://en.wikipedia.org/wiki/Network_File_System" target="_blank" rel="external">Network File System，NFS</a> ）。SMB和NFS功能相似，都是文件级别（相比于块级别iSCSI等方式）的远程存储服务。Windows默认没有安装NFS功能，但可以通过<code>控制面板→程序和功能→启用或关闭Windows功能</code>来添加NFS客户端和服务端软件。</p>
<blockquote>
<p>注意：只能共享某个文件夹，不能单独共享某个文件。Windows会限制能链接的共享用户数量，如果需要提供共享文件服务，Samba是更好的选择。<br>共享配合文件系统的权限设置，可以实现精细的权限控制，比如 “只能上传，不能下载，不能删除” 这样的需求（上传作业的文件服务器）。</p>
</blockquote>
<p>Linux一般内置了smb的客户端（mount.cifs模块）。如果没有，可以执行<code>sudo apt install cifs-utils</code>来安装。</p>
<h2 id="Samba访问Windows提供的共享文件"><a href="#Samba访问Windows提供的共享文件" class="headerlink" title="Samba访问Windows提供的共享文件"></a>Samba访问Windows提供的共享文件</h2><p>Windows上启用共享文件夹只要在文件夹的<code>属性对话框→共享选项卡→高级共享</code>中设置即可，在这个对话框中还可以指定用户和读写权限。共享名和实际的文件夹名可以不同。如果在共享文件名后添加<code>$</code>，就表示是隐藏的，必须通过输入完整路径才能打开。<br><img src="/img/win-share.png" alt="Windows上启用共享文件夹"></p>
<p>创建挂载点<code>mkdir ~/z</code>，并在<code>/etc/fstab</code>中添加<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">//10.1.1.1/文档 /home/ying/z cifs username=Win用户名,password=Win密码,uid=1000,rw,iocharset=utf8,sec=ntlm 0 0</div></pre></td></tr></table></figure></p>
<p>执行<code>sudo mount -a</code>，挂载<code>/etc/fstab</code>中新增的设置。<br>执行<code>ls ~/z</code>，应列出共享文件夹中的内容，确认挂载成功。</p>
<blockquote>
<p>上面的命令将共享文件夹<code>文档</code>挂载到Ubuntu的<code>/home/ying/z</code>，有读写权限。因为设置了终端编码为UTF-8，中文的文件名也能正常显示。<br>其中uid是Ubuntu中用户<code>ying</code>的，具体的值可执行命令<code>id</code>，或在<code>/etc/passwd</code>中查看。</p>
</blockquote>
<h2 id="Windows访问Samba的共享文件"><a href="#Windows访问Samba的共享文件" class="headerlink" title="Windows访问Samba的共享文件"></a>Windows访问Samba的共享文件</h2><p>先要安装<code>Samba File Server</code>，执行<code>sudo apt install samba samba-common</code>。</p>
<blockquote>
<p>查看Samba Server的运行状态，执行<code>systemctl status smbd</code><br>启动，停止或重启服务，执行<code>sudo systemctl start/stop/restart smbd</code></p>
</blockquote>
<p>添加共享文件夹：执行 <code>sudo nano /etc/samba/smb.conf</code>，在末尾添加如下内容，添加了只读的根目录<code>/</code>和可读写的<code>/home/ying</code>目录，但显示为<code>all</code>和<code>ying</code>。<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[all]</div><div class="line">    comment = fs root directory</div><div class="line">    path = /</div><div class="line">;   writeable = no</div><div class="line">;   browseable = yes</div><div class="line">    valid users = ying</div><div class="line"></div><div class="line">[ying]</div><div class="line">    comment = ying&apos;s home</div><div class="line">    path = /home/ying</div><div class="line">    writeable = yes</div><div class="line">    create mask = 0664</div><div class="line">    directory mask = 0775</div><div class="line">;   browseable = yes</div><div class="line">    valid users = ying</div></pre></td></tr></table></figure></p>
<p>将<code>ying</code>添加为smb的共享用户：<code>sudo smbpasswd -a ying</code>， 按提示设置<code>ying</code>的smb密码，<strong>可以与系统密码不同</strong>。<br>重启smbd，使设置生效：<code>sudo systemctl restart smbd</code>。</p>
<blockquote>
<p>Samba的权限问题：Samba中的用户需要是Ubuntu已有的用户，还要给Samba的用户设置相关文件和目录的读写权限。</p>
</blockquote>
<p>从Windows的文件管理器的地址栏访问 <code>\\10.1.1.5</code> ，会看到刚添加的两个共享文件夹。可以在文件夹上右击，快捷菜单中有 <strong>“映射网络驱动器”</strong> 的选项，也可以像普通文件夹一样创建快捷方式。除了IP地址，还可以通过Ubuntu的机器名来访问，若机器名为u，则地址为<code>\\u</code> 。</p>
<p>从macOS和Ubuntu访问共享文件（不论Windows或Ubuntu提供的）的路径格式是<code>smb://10.1.1.5</code>或<code>smb://u</code>。macOS会自动把共享文件挂载到<code>/Volumes</code>下。</p>
<blockquote>
<p>Windows可以通过机器名来访问Ubuntu是因为Samba默认开启了局域网内的<code>WINS</code>名字服务。<br>另一种方法是在<code>hosts</code>文件中为IP地址指定名字。</p>
</blockquote>
<p><img src="/img/smb.png" alt=""></p>
<blockquote>
<p>Samba共享文件与<code>sftp</code>的区别在于，<code>sftp</code>不能直接编辑文件，必须要把文件拷贝下来后才能处理，而操作共享文件跟本机的文件没有太大区别。<br>PS, <code>testparm</code>命令可以用来检查<code>smb.conf</code>的配置是否正确。</p>
<p>参考</p>
<ul>
<li><a href="https://wiki.samba.org/index.php/Setting_up_Samba_as_a_Standalone_Server" target="_blank" rel="external">Setting up Samba as a Standalone Server - samba wiki</a></li>
<li><a href="http://lybing.blog.51cto.com/3286625/1676515" target="_blank" rel="external">在CentOS 7中Samba服务安装和配置</a></li>
</ul>
</blockquote>
<h2 id="更改Samba的默认端口号"><a href="#更改Samba的默认端口号" class="headerlink" title="更改Samba的默认端口号"></a>更改Samba的默认端口号</h2><p>2017年5月份的勒索病毒WanaCrypt会扫描开放445文件共享端口的Windows设备，导致网络管理员禁封了445端口。如果客户端和服务器在同一局域网，通讯都是在二层，不会受到影响，可以正常使用共享文件，但如果经过路由器，就不能使用了。实际中发现即便是在同一个局域网，另外的实验室也无法访问我们实验室的共享文件，可能两个实验室各自的交换机又连到一个三层交换机上了吧。<br>估计445一封了之，是不会再有解封之日了。好在还可以变通一下，修改Samba的端口号，绕过封锁。不爽的是，Windows的默认端口号是无法修改的，而Linux，macOS，Android的ES文件管理器都支持指定端口号，地址格式是<code>smb://10.1.1.5:4455/home/</code>，其中4455是修改后的端口号。</p>
<p>修改Samba的端口号只需在<code>/etc/samba/smb.conf</code>中增加<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">[global]</div><div class="line">   smb ports = 4455 445  # 可以同时监听多个端口号</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h1 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a>远程桌面</h1><h2 id="mstsc"><a href="#mstsc" class="headerlink" title="mstsc"></a>mstsc</h2><p>Windows除家庭版之外均内置了远程桌面服务和客户端，使用的是远程桌面协议<a href="https://en.wikipedia.org/wiki/Remote_Desktop_Protocol" target="_blank" rel="external">Remote Desktop Protocol，RDP</a>。</p>
<ul>
<li>客户端在<code>所有程序→Windows附件→远程桌面连接</code>，或直接执行命令<code>mstsc</code>。</li>
<li>服务程序：依次打开<code>控制面板→所有控制面板项→系统</code>，或<code>Win+X，Y</code>，然后单击左侧的<code>高级系统设置</code>，打开<code>系统属性</code>对话框，在<code>远程</code>选项卡中的<code>远程桌面</code>部分选中<code>允许远程连接到此计算机</code>，并选择某个用户。<br><img src="/img/win-mstsc.png" alt="Windows上的远程桌面客户端"><br><img src="/img/win-mstsc-svr.png" alt="Windows上启用远程桌面"></li>
</ul>
<p>Ubuntu桌面版内置了可以访问Windows远程桌面的客户端；安卓和iOS系统也有远程桌面的App，但这三个系统都没有远程桌面的服务程序，Windows无法通过mstsc远程连接到它们的图形界面。<br>如果是在安卓平板或iPad上使用远程桌面连接到Windows系统，那么Windows会自动切换到触屏模式，就相当于在使用一个Windows系统的平板了，当然是台式机的性能。</p>
<p>Windows远程桌面一般只支持单个用户访问，如果有用户在使用远程桌面，那么本地的就会锁屏；但是服务器版可以设置支持多个用户同时使用远程桌面，彼此都是独立的窗口。</p>
<h2 id="vnc"><a href="#vnc" class="headerlink" title="vnc"></a>vnc</h2><p>VNC（<a href="https://en.wikipedia.org/wiki/Virtual_Network_Computing" target="_blank" rel="external">Virtual Network Computing</a>）是Linux上的远程桌面共享协议。Linux下有多个桌面环境，如Gnome，KDE，unity，xfce等，VNC对不同桌面系统的支持不同。此外，VNC的客户端及服务端也有多种实现，如x11vnc、realvnc、tigervnc、tightvnc、ultravnc等。Ubuntu Unity下自带了<code>远程共享</code>程序实现了VNC功能。由于vnc远比ssh占用的网络带宽大，而Linux上的大部分操作可以通过ssh来执行，所以不推荐使用VNC。<br>VNC默认桌面会话使用5900端口，可以开启多个桌面会话，新的VNC桌面会话的端口号依次增加。与Windows的远程桌面不同，VNC在远程访问时不会锁屏，而是同步显示默认桌面会话的显示。</p>
<p>可以参考教程[<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-16-04" target="_blank" rel="external">https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-vnc-on-ubuntu-16-04</a>] ，在Ubuntu上安装和配置xfce桌面及tightvnc服务端。</p>
<p>Windows上没有内置的VNC客户端，有一些免费的<code>VNC-Viewer</code>程序。</p>
<blockquote>
<p>注意： 按上面的设置启用VNC后，使用的是xfce桌面环境，<br>默认的 <code>Tab</code> 键补全终端命令与窗口管理的快捷键冲突，需要在“Settings-&gt; Window Manager -&gt; Keyboard”中清除 <code>Switch Window from same application</code> 关联的快捷键<br>还可以在 “Settings-&gt; Keyboard -&gt; application shortcut” 中设置打开终端的快捷键 <code>exo-open --launch TerminalEmulator ~ Ctrl+Alt+T</code></p>
</blockquote>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><p>在局域网之外，如果网络连接比较复杂，mstsc或vnc可能都无法穿过机构强制的防火墙。有一些远程访问软件，比如 <strong><a href="https://www.teamviewer.com" target="_blank" rel="external">TeamViewer</a></strong>，<a href="http://sunlogin.oray.com/zh_CN/" target="_blank" rel="external">向日葵</a>等，可以实现广域网情形的远程访问，前提是两端的机器都能访问Internet公网，而mstsc和vnc则不要求必须能够访问公网。另一种方法是申请机构内的VPN。</p>

      

      
        
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/misc/2016/udpnuurufa/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          双拼输入法
        
      </div>
    </a>
  
  
    <a href="/misc/2016/install-win-10/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">安装和设置Windows 10</div>
    </a>
  
</nav>

  
</article>

</section>
        <aside id="sidebar">
  <nav class="menus">
  	<ul>
  		<li><a href="/"><i class="icon icon-home"></i></a></li>
  		
			<li><a href="/archives"><i class="icon icon-fenlei"></i></a></li>
  		
  		
  			<li><a href="https://github.com/ying-zhang" target="_blank"><i class="icon icon-github"></i></a></li>
  		
			
  			<li><a href="/atom.xml" target="_blank"><i class="icon icon-tag"></i></a></li>
  		
  	</ul>
  </nav>
  <a id="go-top" href="#"><i class="icon icon-up"></i></a>
</aside>
      </div>
      <footer id="footer">
  
	<div id="footer-info" class="inner">
	  &copy; 2018 Ying ZHANG 
	  - Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	  - Theme <a href="https://github.com/hejianxian/hexo-theme-jane/" target="_blank">Jane</a>
		- Project Source at <a href="https://github.com/ying-zhang/ying-zhang.github.io/" target="_blank">Github</a>
	</div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://github.com/ying-zhang" class="mobile-nav-link">Github</a>
  
    <a href="/atom.xml" class="mobile-nav-link">RSS</a>
  
</nav>
    

<script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>