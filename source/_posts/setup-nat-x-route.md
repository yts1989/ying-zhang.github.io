title: CentOS 7 及 Ubuntu 16.04 设置 NAT 网络
date: 2017-04-15
category: [misc]
tags:

---
记录一下设置一台双网卡的CentOS服务器提供 NAT 转发，作为内网网关，其它服务器的默认网关更改为此节点，添加路由，以及处理外部ssh登录变慢的问题。
<!--more-->

<!-- TOC -->

- [CentOS 7 设置和使用NAT](#centos-7-%E8%AE%BE%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8nat)
    - [NAT网关的设置](#nat%E7%BD%91%E5%85%B3%E7%9A%84%E8%AE%BE%E7%BD%AE)
        - [允许IP转发](#%E5%85%81%E8%AE%B8ip%E8%BD%AC%E5%8F%91)
        - [设置`iptables`规则](#%E8%AE%BE%E7%BD%AEiptables%E8%A7%84%E5%88%99)
    - [设置其它 CentOS 7 机器使用NAT网络](#%E8%AE%BE%E7%BD%AE%E5%85%B6%E5%AE%83-centos-7-%E6%9C%BA%E5%99%A8%E4%BD%BF%E7%94%A8nat%E7%BD%91%E7%BB%9C)
        - [切换默认网关](#%E5%88%87%E6%8D%A2%E9%BB%98%E8%AE%A4%E7%BD%91%E5%85%B3)
        - [为`em1`添加静态路由](#%E4%B8%BAem1%E6%B7%BB%E5%8A%A0%E9%9D%99%E6%80%81%E8%B7%AF%E7%94%B1)
- [Ubuntu 16.04 设置和使用NAT](#ubuntu-1604-%E8%AE%BE%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8nat)
    - [设置NAT](#%E8%AE%BE%E7%BD%AEnat)
        - [允许IP转发](#%E5%85%81%E8%AE%B8ip%E8%BD%AC%E5%8F%91)
        - [设置iptables规则](#%E8%AE%BE%E7%BD%AEiptables%E8%A7%84%E5%88%99)
    - [设置其它机器使用NAT网络](#%E8%AE%BE%E7%BD%AE%E5%85%B6%E5%AE%83%E6%9C%BA%E5%99%A8%E4%BD%BF%E7%94%A8nat%E7%BD%91%E7%BB%9C)
- [其它问题](#%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98)
    - [禁用各机器的SSHD DNS选项，解决ssh登录很慢的问题](#%E7%A6%81%E7%94%A8%E5%90%84%E6%9C%BA%E5%99%A8%E7%9A%84sshd-dns%E9%80%89%E9%A1%B9%EF%BC%8C%E8%A7%A3%E5%86%B3ssh%E7%99%BB%E5%BD%95%E5%BE%88%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98)
    - [取消原来设置的http代理](#%E5%8F%96%E6%B6%88%E5%8E%9F%E6%9D%A5%E8%AE%BE%E7%BD%AE%E7%9A%84http%E4%BB%A3%E7%90%86)
- [PS: 使用 SSH 隧道](#ps-%E4%BD%BF%E7%94%A8-ssh-%E9%9A%A7%E9%81%93)

<!-- /TOC -->

小组有一个Dell的刀片服务器机柜，每台机器都是双网卡，分别连到了2个LAN。
+ 一个LAN是学校的公网IP（下文记为`2.2.2.0/24`网段）。装好CentOS 7系统后，`em1`网卡在公网LAN，可以在校内直接访问`em1`的IP，但由于学校网络管理限制，校外无法访问。所以说这个公网IP跟私网IP差不了多少。
+ 另一个LAN是用于远程管理的机房内私网IP（下文记为`10.0.0.0/24`网段），`em2`网卡在这个私网LAN。服务器的iDRAC也在这个私网里。这个私网的网关是某个机器上的VPN服务提供的，IP是`10.0.0.1`。登录到这个VPN之后，就可以远程访问iDRAC，也可以通过私网IP ssh登录到机器。

一直是远程管理，只去过一次机房，还不清楚服务器的具体组网拓扑。按理也可以修改一些设置，通过VPN的网关访问外网，不过没有VPN这台机器的管理权限，只好另外找机器设置NAT。

# CentOS 7 设置和使用NAT
虽然学校的网络管理限制了刀片集群的LAN使用公网IP连不了校外网络，而且不能登录个人的外网帐号，好在可以填表申请一个`147`的公网IP（记对应的机器是`n147`）直通校外网。
之前是通过在`n147`上提供Squid HTTP代理服务的方式使其它机器能够访问外网，但代理用起来实在是不方便，所以改成NAT方式，这样其它机器将`n147`的私网IP作为网关，使用私网IP就可以访问外网了。在NAT模式下，`n147`就像一个软件实现的家用路由器。
## NAT网关的设置
作为网关的机器名是`n147`，公网IP是`2.2.2.147/24`，对应`em1`网卡；私网IP是`10.0.0.147/24`，对应`em2`网卡。

### 允许IP转发
其它机器从`10.0.0.0/24`网段发送的数据包会被`em2`网卡接收，如果目标IP是外网，需要交给`em1`网卡发送出去。需要开启IP转发选项，才能允许不同网卡间转发数据：
```
# 查看是否启用IP转发，如果是0则没有开启，是1则已经开启
cat /proc/sys/net/ipv4/ip_forward

# 可以修改上述文件的值来改变设置，但重启后会恢复默认值。
# 需要将设置写入系统配置文件 /etc/sysctl.conf 或 /etc/sysctl.d/ip_forward.conf
# 内容为
net.ipv4.ip_forward = 1
```

### 设置`iptables`规则
安装必要软件并启用服务：
```
yum install -y net-tools iproute iptables iptables-services
systemctl disable firewalld
systemctl stop firewalld
systemctl enable iptables
```

>`net-tools`这个程序包有 `ifconfig`，`netstat`，`route`等命令，而`iproute2`（rpm包名为`iproute`）包括`tc`，`ip`，`ss`等命令，是`net-tools`的改进。

通过`iptables`命令行可以添加NAT规则，但重启后也是会恢复默认值，应当将修改后的规则设置用`iptables-save`命令输出，然后保存起来。
这里直接使用`iptables-save`生成的配置项，保存到配置文件 `/etc/sysconfig/iptables`，内容如下：
```
# Generated by iptables-save v1.4.21 on Thu Apr 20 22:14:39 2017
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o em1 -j MASQUERADE  
COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A FORWARD -i em2 -j ACCEPT
COMMIT
```

其中涉及NAT转发的是`-A POSTROUTING -o em1 -j MASQUERADE ` 和 `-A FORWARD -i em2 -j ACCEPT`。
此外还删除了原来禁止`ping`的规则：
`-A INPUT -j REJECT --reject-with icmp-host-prohibited`
`-A FORWARD -j REJECT --reject-with icmp-host-prohibited`

重启`iptables`服务`systemctl restart iptables`。

>可以修改`/etc/sysconfig/iptables-config` 配置文件，设置下面三个选项均为`yes`来自动保存`iptables`规则
+ `IPTABLES_MODULES_UNLOAD="yes"`
+ `IPTABLES_SAVE_ON_STOP="yes"`
+ `IPTABLES_SAVE_ON_RESTART="yes"`

>参考
+ [保存iptable规则并开机自动加载](http://salogs.com/news/2015/08/20/iptables-save/)
+ [iptables用法初解](http://blog.csdn.net/hepeng597/article/details/8270138)

## 设置其它 CentOS 7 机器使用NAT网络
### 切换默认网关
安装系统后，默认网关是`em1`所在LAN的`2.2.2.1`，需要将其更改为`em2`所在LAN的`10.0.0.147`，修改如下的网卡配置文件：
```
# /etc/sysconfig/network-scripts/ifcfg-em1
DEFROUTE=no

# /etc/sysconfig/network-scripts/ifcfg-em2
DEFROUTE=yes
# ...
GATEWAY=10.0.0.147
DNS1=233.5.5.5
DNS2=223.6.6.6
```

其中`em2`的网关即刚才配置的`n147`的私网IP，由于没有在`n147`上运行DNS服务，这里使用的是阿里的DNS。也可以安装配置`dnsmasq`等DNS服务器。
### 为`em1`添加静态路由
修改默认网关后，查看路由表，
```
# route -n
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.147      0.0.0.0         UG    100    0        0 em2
10.0.0.0        0.0.0.0         255.255.0.0     U     100    0        0 em2
2.2.2.0         0.0.0.0         255.255.255.0   U     100    0        0 em1
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
```

发现从`em1`收发的数据包也要经过默认网关`10.0.0.147`，而这个网关在机房的私网内，**外部不能直接访问，导致外部无法公网IP访问服务器**。为此，需要为`em1`添加静态路由，不走`10.0.0.147`，新建文件`/etc/sysconfig/network-scripts/route-em1`，内容如下：
```
2.2.0.0/16    via 2.2.2.1
172.0.0.0/8   via 2.2.2.1
```

其中
+ `2.2.0.0/16`网段是学校 **有线** 网络的IP网段
+ `172.0.0.0/8`网段是学校 **无线** 网络的IP网段。
>注意
+ `docker0`网桥默认也是B类私网的`172.x.0.0/16`网段，但其路由项更具体，所以[不会造成冲突](http://answ.me/post/configure-docker-subnet/)。
+ `docker0`网桥实际也工作在NAT模式，也需要开启IP转发。

重启网络，更新配置，`systemctl restart network`。

> 参考：[Two Default Gateways on One System](https://www.thomas-krenn.com/en/wiki/Two_Default_Gateways_on_One_System)

# Ubuntu 16.04 设置和使用NAT

Ubuntu 16.04 参考上面 CentOS 7 设置和使用NAT的步骤即可————怎么可能！
因为用到的工具都是`net-tools`，`iproute`和`iptables`这3个包里的，配置文件的内容是一样的，但配置文件的路径和启动方式就不一样了。
## 设置NAT

### 允许IP转发
直接修改系统配置文件 `/etc/sysctl.conf`，里面已经有支持的配置项，取消`net.ipv4.ip_forward = 1`的注释即可。

### 设置iptables规则
还是使用的`iptables`，为了使修改后的规则能够保存，规则跟上面CentOS的基本一样。为什么说是基本呢？网卡的默认名字改了： CentOS 7下是`em1`，`em2`，Ubuntu 16.04下是`eno1`，`eno2`，所以要把规则中对应的网卡名改过来。

然后要找到Ubuntu 16.04下系统会自动读取的iptables规则文件路径，参考[IptablesHowTo - Ubuntu wiki](https://help.ubuntu.com/community/IptablesHowTo)，，**随便把规则保存到哪，反正系统不会自动加载**，需要自己添加一个启动脚本。
因为机器是多网卡，启动脚本不好关联某个网卡，所以放在与网卡启动关联的脚本目录里，脚本文件是 `/etc/network/if-pre-up.d/iptablesload`，内容如下，
```
#!/bin/sh
iptables-restore < /etc/iptables.rules
exit 0
```

可见`/etc/iptables.rules`是保存的`iptables`规则，这个位置是任意的，只要跟启动脚本中保持一致就行了。启动脚本的名字也是任意的，只要放在那个路径下就可以了。**但是，你要自己来写这个脚本**。

编辑好`/etc/iptables.rules` 和 `/etc/network/if-pre-up.d/iptablesload`之后，重启网络服务。

虽然都是用`systemd`来管理系统服务，但服务的名字又不一样了，CentOS的网络服务名称是`network.service`，而Ubuntu则是`networking.service`。
执行命令`sudo systemctl restart networking`，重启网络服务。不过，其实我们是用`iptables`来实现的NAT，而不是`networking.service`相关服务，不过由于上面的那个脚本`iptablesload`会在网卡启动之前被执行，所以顺便完成了我们的目标。

## 设置其它机器使用NAT网络

同样，在其它Ubuntu机器上也要切换默认网关，为eno1添加静态路由。情况又不一样了，Ubuntu的所有网卡配置和静态路由都保存在`/etc/network/interface`这个文件里，这个倒是方便了—— **[如果面对空空的配置文件，你能猜到各配置项是什么的时候](https://askubuntu.com/questions/168033/how-to-set-static-routes-in-ubuntu-server)**。
好在安装系统的时候设置了网卡，给`eno2`生成了一些配置项可以参考。修改后的内容如下。
```
auto lo
iface lo inet loopback

auto eno1
iface eno1 inet static
  address 2.2.2.140
  netmask 255.255.255.0
  network 2.2.2.0
  broadcast 2.2.2.255
  # gateway 2.2.2.1
  up ip route add 2.2.0.0/16   via 2.2.2.1 || true
  up ip route add 2.2.2.0/24   via 2.2.2.1 || true
  up ip route add 172.0.0.0/8  via 2.2.2.1 || true

# The primary network interface
auto eno2
iface eno2 inet static
  address 10.0.0.140
  netmask 255.255.255.0
  network 10.0.0.0
  broadcast 10.0.0.255
  gateway 10.0.0.147
  # dns-* options are implemented by the resolvconf package, if installed
  dns-nameservers 233.5.5.5
```
>注意
+ 不是像CentOS那样明确地在各网卡的配置文件中说明是否该网卡作为默认路由网关，而是哪个网卡写了`gateway`就以它作为默认网关，如果2个网卡都写了，只有最后写的那个有效，所以最好明确地只保留一个`gateway`项。
+ `up ip route add 2.2.0.0/16   via 2.2.2.1 || true`其实也就是一句启动网卡后顺便执行的脚本，如果你愿意，这里写一句`up echo helloworld`也没问题。后面的`|| true`是让脚本执行时忽略可能的错误，继续执行。这里使用的是`ip`命令，如果使用`route`命令，效果也是一样的，前提是已经安装了`net-tools`或`iproute`软件包。使用`netmask`和`CIDR`格式都可以。
+ 哪个网卡的路由就写到对应的网卡下，这样执行`ifup eno1`这样的单独启动某个网卡的命令也会自动执行相应的命令添加该网卡的路由。

执行命令`sudo systemctl restart networking`，重启网络服务。
查看一下更新后的路由表，
```
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.147      0.0.0.0         UG    0      0        0 eno2
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0        0 eno2
2.2.0.0         2.2.2.1         255.255.0.0     UG    0      0        0 eno1
2.2.2.0         0.0.0.0         255.255.255.0   U     0      0        0 eno1
172.0.0.0       2.2.2.1         255.0.0.0       UG    0      0        0 eno1
```

注意倒数第二行：`2.2.2.0    0.0.0.0    255.255.255.0   U    0    0    0    eno1`，这个是自动添加的。
它的网关并不是`2.2.2.1`，即便在`interface`中强制器网关为`2.2.2.1`，也会被改为`0.0.0.0`。因为`2.2.2.0/24`是本LAN的数据包，经`ARP`协议获得目标的`MAC`地址后，会被直接发到目标地址，而不会经网关`2.2.2.1`转发，虽然路由表中默认网关是`0.0.0.0`，也不会按路由表转发到`10.0.0.147`。

# 其它问题
下面的问题是在除NAT网关外的其它机器上设置的。

## 禁用各机器的SSHD DNS选项，解决ssh登录很慢的问题
修改默认网关，添加路由之后，虽然可以从外部通过公网IP `ping`通机房内的机器，但`ssh`登录过程需要等待很长时间。
参考[ssh连接的时候很慢，ping的速度非常好](http://blog.itpub.net/7345798/viewspace-1055461/)这篇文章，修改各机器上`sshd`的选项如下：
```
sed -i "'s/.*UseDNS.*/UseDNS no/g'" /etc/ssh/sshd_config
systemctl restart sshd
```

## 取消原来设置的http代理
注释掉配置文件中`http_proxy`和`https_proxy`环境变量的声明，并执行
```
unset http_proxy
unset https_proxy
```

# PS: 使用 SSH 隧道
一般可以通过服务器的公网IP在校内登录到机器上，有时把机器的配置搞乱了，需要连接到内网，使用iDRAC来管理机器，这时就要连接VPN了。其实也可以不连接VPN，而利用其它正常机器的SSH创建隧道，实现连接内网的目的。
以Windows客户端为例，安装了Windows版的`git`后，会附带一些`mingw`命令程序（不是完整的`mingw`），首先将这些命令的可执行文件所在路径添加到`Path`环境变量，比如是`E:\App\git\usr\bin;E:\App\git\mingw64\bin;E:\App\git\bin`，然后就可以在Windows命令行使用这些命令了。其中就有`ssh.exe`。
在Windows命令行窗口执行
```
ssh -NfD 1088 -i C:\Users\ying\.ssh\id_rsa root@n147
```

这个命令执行成功后会退出，返回到命令提示符，但实际仍在后台监听本机的1088端口`127.0.0.1:1088`。**如果需要停止SSH隧道，关闭该命令窗口即可**。
因为我在Windows的`C:\Windows\System32\drivers\etc\hosts`文件中添加了`n147`的项，所以可以直接输入名字而不必是IP地址。

在IE或控制面板打开`Internet选项`，
+ 在`连接`选项卡单击`局域网设置`按钮，
+ 在弹出的对话框勾选`为LAN使用代理服务器`，然后单击`高级`，
+ 在弹出的对话框取消勾选`对所有协议使用相同的代理服务器`，然后在`套接字`对应的文本框填入`127.0.0.1`和上面命令中监听的端口号`1088`，
+ 在`例外`文本框中删掉`10.*0;`的内容，然后一路确定关闭所有对话框。
这时应该可以用IE或Chrome访问机房内网的iDRAC。**如果需要正常访问网页，需要取消勾选`为LAN使用代理服务器`**。

![](/img/sock5-proxy.png)
